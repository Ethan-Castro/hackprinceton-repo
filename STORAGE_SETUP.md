# Storage & Database Setup - Quick Reference

## Status: ‚úÖ Ready for Setup

Your application is configured to use **Neon PostgreSQL** for persistent data storage. Follow these steps to get up and running.

## 5-Minute Quick Start

### Step 1: Add Database URL to `.env.local`

Create or update `.env.local` in your project root with:

```bash
# Copy this from env.example
DATABASE_URL=postgresql://neondb_owner:npg_3CnOGubvJ8zh@ep-frosty-sound-a4g18j9l-pooler.us-east-1.aws.neon.tech/neondb?sslmode=require
```

**Important:** `.env.local` is gitignored - never commit it!

### Step 2: Initialize Database Tables

**Option A - Via API (Easiest):**
```bash
# Start your dev server
npm run dev

# In another terminal, initialize:
curl -X POST http://localhost:3000/api/db-init

# Check status:
curl http://localhost:3000/api/db-init/status
```

**Option B - Via SQL Editor:**
1. Visit [Neon Console](https://console.neon.tech)
2. Open SQL Editor
3. Paste the SQL from `DATABASE_SETUP.md` "Option B"
4. Run all commands

### Step 3: Test It Works

Navigate to:
- http://localhost:3000/db-demo - Test comments table
- http://localhost:3000/db-demo-server-action - Test with Server Actions

Try adding a comment - if it saves and reloads, you're all set! ‚úÖ

## What's Included

### Database Tools (`lib/neon.ts`)
```typescript
// Query multiple rows
const rows = await query('SELECT * FROM comments');

// Query single row
const row = await queryOne('SELECT * FROM comments WHERE id = $1', [1]);

// Insert/Update with unpooled connection
await queryWithPostgres`
  INSERT INTO comments (comment) VALUES (${'Hello'}) RETURNING *
`;

// Transactions
await withTransaction(async (sql) => {
  await sql`INSERT INTO comments VALUES ...`;
});
```

### Available Tables

| Table | Purpose | Demo Page |
|-------|---------|-----------|
| `comments` | Simple demo storage | `/db-demo` |
| `posts` | Blog/content posts | - |
| `trackers` | Health tracking | `/health/records` |
| `tracker_entries` | Health data points | `/health/records` |
| `templates` | Document templates | `/business/templates` |
| `chat_history` | Conversation history | - |

### API Endpoint

```bash
# POST /api/db-init - Initialize database
# GET /api/db-init/status - Check connection & tables
# POST /api/db-init?force=true - Reinitialize (drops tables!)
```

## Common Issues & Fixes

| Issue | Fix |
|-------|-----|
| `DATABASE_URL not found` | Add to `.env.local` and restart dev server |
| `Connection refused` | Check internet, verify URL is correct |
| `Table already exists` | Use `?force=true` to reinitialize or it's normal - ignore |
| `Permission denied` | Check Neon user permissions or contact support |

## Next: Use It in Your Code

### Server Component
```typescript
import { query } from '@/lib/neon';

export default async function Page() {
  const data = await query('SELECT * FROM comments');
  return <div>{/* use data */}</div>;
}
```

### Server Action
```typescript
'use server';
import { query } from '@/lib/neon';

export async function addComment(formData: FormData) {
  await query('INSERT INTO comments (comment) VALUES ($1)', 
    [formData.get('comment')]
  );
}
```

### API Route
```typescript
import { query } from '@/lib/neon';

export async function GET() {
  const data = await query('SELECT * FROM comments');
  return Response.json(data);
}
```

## Environment Variables

### Available Variables

```bash
# Required (in .env.local)
DATABASE_URL=...              # Pooled connection

# Optional
DATABASE_URL_UNPOOLED=...     # For transactions
POSTGRES_URL=...              # Vercel Postgres alias
POSTGRES_URL_NON_POOLING=...  # Vercel Postgres unpooled
```

### Getting Your Connection String

1. Go to [Neon Console](https://console.neon.tech)
2. Click your project
3. Click "Connection String" button
4. Copy the full URL
5. Paste into `.env.local`

## Performance Tips

- ‚úÖ Queries use parameterized statements (SQL injection safe)
- ‚úÖ Indexes created on frequently queried columns
- ‚úÖ Connection pooling enabled by default
- ‚úÖ JSONB columns for flexible data storage
- ‚ö†Ô∏è Use `DATABASE_URL_UNPOOLED` for transactions only

## Production Checklist

- [ ] Set `DATABASE_URL` in production environment secrets
- [ ] Use strong passwords (already generated by Neon)
- [ ] Enable Neon backups
- [ ] Monitor connection usage
- [ ] Consider read replicas for high traffic
- [ ] Implement query monitoring/logging
- [ ] Set up alerts for connection issues

## Want to Learn More?

- üìñ Full guide: `DATABASE_SETUP.md`
- üîß See examples: `app/db-demo/page.tsx`, `app/db-demo-server-action/page.tsx`
- üèóÔ∏è Database utils: `lib/neon.ts`
- üöÄ Init code: `lib/db-init.ts`, `app/api/db-init/route.ts`

---

**Status:** Your database is ready to go! üéâ

